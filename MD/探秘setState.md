# æ¢ç§˜setState

### ä¸€ã€setStateæ˜¯å¼‚æ­¥çš„
é¦–å…ˆæˆ‘ä»¬æ˜ç¡®ä¸€ç‚¹ï¼ŒsetStateæ˜¯å¼‚æ­¥çš„æ–¹æ³•ã€‚ï¼ˆä¸èƒ½ä¿è¯æ˜¯åŒæ­¥çš„ï¼‰ï¼Œç›¸ä¿¡å„ä½éƒ½å†™è¿‡è¿™æ ·çš„ä»£ç ã€‚
```javascript
    state = {
        val: '456'
    };
    ...
    ...
    componentDidMount(){
        this.setState({
            val: '123'
        });
        console.log(this.state.val);  // '456'
    }
```
æˆ‘åœ¨ç¬¬ä¸€æ¬¡å†™å‡ºè¿™æ ·çš„ä»£ç çš„æ—¶å€™ï¼Œä¹Ÿå¾ˆè¯§å¼‚ï¼Œä¸ºå•¥ä¸èƒ½å¾—åˆ°æ­£ç¡®çš„`state`çš„å•Šï¼ç™¾æ€ä¸å¾—å…¶è§£.....ğŸ˜’

åæ¥æŸ¥äº†èµ„æ–™æ‰å‘ç°...`setState`æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„æ–¹æ³•ã€‚è¿™çœŸçš„å¾ˆéš¾å‘ç°ã€‚
### äºŒã€setStateåˆå¹¶æ›´æ–°
å…ˆæ¥çœ‹çœ‹setStateçš„æ›´æ–°æœºåˆ¶:
>   setState é€šè¿‡ä¸€ä¸ªé˜Ÿåˆ—æœºåˆ¶å®ç° state æ›´æ–°ã€‚å½“æ‰§è¡Œ setState æ—¶ï¼Œä¼šå°†éœ€è¦æ›´æ–°çš„ state åˆå¹¶ åæ”¾å…¥çŠ¶æ€é˜Ÿåˆ—ï¼Œè€Œä¸ä¼šç«‹åˆ»æ›´æ–° this.stateï¼Œé˜Ÿåˆ—æœºåˆ¶å¯ä»¥é«˜æ•ˆåœ°æ‰¹é‡æ›´æ–° stateã€‚

å¯ä»¥çœ‹åˆ°Reactå¾ˆæ™ºèƒ½çš„å¸®æˆ‘ä»¬æŠŠsetStateçš„æ“ä½œéƒ½æ”¶é›†èµ·æ¥ï¼Œé›†ä¸­å¤„ç†ï¼Œå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæˆ‘ä»¬å†™å‡ºä»¥ä¸‹ä»£ç æ¥å½±å“æ€§èƒ½ï¼š
```javascript
    this.setState({
        val: '123'
    });
    this.setState({
        val: '456'
    })
```
ä»–ä¼šå°†ä¸Šè¿°å¤šä¸ª`setState`æ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º`æ‰¹é‡æ›´æ–°ï¼ˆbatchedUpdatesï¼‰`ï¼Œå¦‚æœæˆ‘ä»¬åœ¨`render`ä¸­æ§åˆ¶å°è¾“å‡ºçš„è¯ï¼Œå¯ä»¥å‘ç°å…¶å®åªè§¦å‘äº†ä¸€æ¬¡`render`æ–¹æ³•ã€‚è§†å›¾åªæ›´æ–°äº†ä¸€æ¬¡ï¼Œç”±æ­¤å¯éªŒè¯`setState`è¢«åˆå¹¶äº†ã€‚

è¿˜æœ‰è¿™ç§æ“ä½œï¼š
```javascript
   // sum 1
    for(let i = 0; i < 4; i ++){
      this.setState({
        sum: i + this.state.sum
      })
    }
```
`render`æ–¹æ³•ä¹Ÿåªä¼šè§¦å‘ä¸€æ¬¡ï¼Œå¹¶ä¸”ä¿®æ”¹åçš„`sum`å€¼ä¸º4ï¼Œå¯¹äºåŒä¸€ä¸ªstateçš„ä¿®æ”¹éƒ½ä¼šè¢«åé¢çš„è¦†ç›–ã€‚

>   æ³¨æ„ä¸€ç‚¹ï¼Œåœ¨`render`æ–¹æ³•è°ƒç”¨å‰ï¼Œ`state`æ˜¯éƒ½ä¸ä¼šæ›´æ–°çš„ã€‚

è¿™ç‚¹çœŸçš„æ˜¯åšçš„éå¸¸å¥½å‘€ï¼Œæƒ³æƒ³çœ‹ä¸Šé¢è¿™ä¸¤ç§æƒ…å†µå®Œå…¨å¯ä»¥ç”¨ä¸€æ¬¡`setState`æ“ä½œæ¥å®Œæˆã€‚å°±ç®—æˆ‘ä»¬æ˜¯æ–°æ‰‹ï¼ŒReactä¹Ÿå°½é‡çš„ä¸ºæˆ‘ä»¬è€ƒè™‘äº†å¾ˆå¤š....æ˜¯å§ ğŸ˜„

ä½†æ˜¯è¿™æ ·ä¹Ÿå¸¦æ¥äº†é—®é¢˜ã€‚å‡å¦‚æˆ‘ä»¬è¦ç”¨stateçš„å€¼ï¼Œé€šè¿‡å‡ æ­¥æ¥è®¡ç®—ä¸€ä¸ªç»“æœï¼Œè¿˜å¾—æ‰¾ä¸ªå˜é‡tmpç»™æ¯æ¬¡è®¡ç®—çš„ç»“æœå­˜èµ·æ¥ã€‚ååˆ†çš„ä¸ä¼˜é›…ã€‚æœ‰æ²¡æœ‰è§£å†³åŠæ³•å‘¢...æœ‰çš„ï¼Œçœ‹ä¸‹é¢çš„ä»‹ç»ã€‚

å…ˆæ¥çœ‹ä¸€ä¸‹setStateçš„æ‰§è¡Œè¿‡ç¨‹
![setState](https://github.com/w771854332/bengiBlog-node/blob/master/public/screenshot/setState.png?raw=true)

çœ‹ä¸Šå»è›®å¤æ‚çš„æŠŠã€‚å…¶å®ç®€å•çš„æ¥çœ‹ï¼ŒsetStateè¢«åˆ†ä¸ºä¸¤ç§çŠ¶æ€ï¼š
-   æ‰¹é‡æ›´æ–°æ¨¡å¼
-   æ™®é€šæ›´æ–°æ¨¡å¼

ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°çš„ä¾‹å­å°±æ˜¯å¤„äºæ‰¹é‡æ›´æ–°æ¨¡å¼ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```javascript
export default class App extends React.Component {
  state = {
    sum: 1
  };
  componentDidMount(){
    setTimeout(()=>{
      this.setState({
        sum: '123'
      })
      console.log('did',this.state.sum);
      this.setState({
        sum: '345'
      })
      console.log('did',this.state.sum);
    }, 0);

  }
  render(){
    console.log('render',this.state.sum)
    return (
      <div>{this.state.sum}</div>
    )
  }
}
```

psï¼šsetTimeoutæ—¶é—´è®¾ä¸º0çš„æ„æ€å°±ä¸æäº†
ä½ çŒœæ§åˆ¶å°è¾“å‡ºçš„ç»“æœæ˜¯å•¥ ğŸ˜„


```javascript
    // render 1
    // render 123
    // did 123
    // render 345
    // did 345
```

å¥½å•¦ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„æ™®é€šæ›´æ–°æ¨¡å¼ã€‚æ„æ€ä¹Ÿéå¸¸å¥½ç†è§£ï¼Œåœ¨åŒä¸€ä¸ª`æ‰§è¡Œæ ˆ`ä¸­çš„æ¯ä¸ª`setState`æ“ä½œéƒ½ä¼šè§¦å‘ç”Ÿå‘½å‘¨æœŸ -> æ›´æ–°stateå¹¶æ›´æ–°è§†å›¾ï¼ˆç¡®å®æ˜¯è¦ç­‰åˆ°renderä¹‹æ—¶/åï¼Œæ‰èƒ½æ‹¿åˆ°æ­£ç¡®çš„stateï¼‰

æˆ‘ä»¬å†æ¥çœ‹ä¸€æ¬¡é‚£å¼ å›¾

![setState](https://github.com/w771854332/bengiBlog-node/blob/master/public/screenshot/setState.png?raw=true)

æˆ‘ä»¬å‘ç°ï¼ŒReactåœ¨ä¸€æ¬¡`æ‰§è¡Œæ ˆ`ä¸­ï¼Œä¼šå°†æ‰€æœ‰çš„`setState`æ“ä½œéƒ½å‹å…¥`dirtyComponents`ä¸­ï¼ŒReactä¼šæ¯”è¾ƒ`dirtyComponents`çš„é•¿åº¦ï¼Œè¿›è¡Œ`updateComponent`æ“ä½œã€‚è¿›è¡Œç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚

é’ˆå¯¹`setTimeout`æ¥è¯´ï¼Œä»–ç›¸å½“äºæ–°å¼€äº†ä¸€ä¸ª`Macrotask Queue`ã€‚è¿™éƒ½æ˜¯åè¯äº†ã€‚ç°åœ¨ç†è§£èµ·æ¥å°±æ˜¯ï¼Œ`setTimeout`ä¼šè·³å‡ºå½“å‰æ‰§è¡Œé˜Ÿåˆ—ï¼Œæ²¡æœ‰å‰ç½®çš„`batchedUpdate`çš„æ–¹æ³•è°ƒç”¨ï¼Œåœ¨åˆ¤æ–­`æ˜¯å¦å¤„äºæ‰¹é‡æ›´æ–°æ¨¡å¼`æ—¶ï¼Œèµ°å‘äº†å³è¾¹ã€‚
### äºŒã€setStateå…¶å®æ²¡è¿™ä¹ˆç®€å•
æ—¢ç„¶`setState`æ˜¯å¼‚æ­¥çš„æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ‰æ²¡æœ‰åŠæ³•æ‹¿åˆ°æ›´æ”¹ä¹‹åçš„stateå‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚å¾ˆç®€å•ï¼Œ`setState`çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚ ğŸ˜’...æ‡µé€¼

å¦‚æœæ²¡æœ‰äººå‘Šè¯‰ä½ ï¼Œææ€•æ€æ ·éƒ½æƒ³ä¸åˆ°å§ã€‚ã€‚

```javascript
    this.setState({
        sum: '123'
    },()=>{
        console.log(this.state.sum); // '123'
    });
```
è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ°æ›´æ”¹åçš„`state`ï¼Œä¸è¿‡è¿™ä¸ªå›è°ƒå‡½æ•°è²Œä¼¼æ²¡å•¥ç”¨ã€‚ã€‚ã€‚è·Ÿ`componentDidUpdate`å·®ä¸å¤šå˜›ã€‚å¦‚æœæˆ‘ä»¬æƒ³å®ç°åŒæ­¥æ›´æ–°çš„è¯ï¼Œä¹Ÿä¸ç”¨è¿™ç§æ–¹æ³•

```javascript
    setTimeout(()=>{
      this.setState({
        sum: '123'
      })
      console.log('did',this.state.sum);
      this.setState({
        sum: '345'
      })
      console.log('did',this.state.sum);
    }, 0);
```

è¿™æ ·å°±å¯ä»¥å‘€ã€‚ã€‚ä¸è¿‡è¿™ç§æ–¹å¼ï¼Œä¼šåœ¨è§†å›¾ä¸Šçœ‹åˆ°é£é—ªè€Œè¿‡çš„ä¸­é—´ç»“æœï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå¥½æ–¹æ³•ã€‚

è¿™æ˜¯ä¸€ç§å®ç°ï¼Œè¿˜æœ‰ä¸€ä¸ªä½ æ›´æƒ³ä¸åˆ°çš„äº‹æƒ…

-----

`setState`æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå…¶å®ä»–åº”è¯¥æ˜¯è¿™æ ·çš„
```javascript
    this.setState((prevState, nextProps)=>({
      ...prevState
    }))
```

æœ‰æ²¡æœ‰éœ‡æƒŠçš„æ„Ÿè§‰...çœŸæ˜¯ä¸ªå¤§å½©è›‹å•Š

è¿™ä¸ªå¯ä¸åªæ˜¯å˜ä¸€å˜å†™æ³•è¿™ä¹ˆç®€å• ğŸ˜„

```javascript
class App extends React.Component {
  state = {
    number: 1
  };
  clickHandle = () => {
    this.setState((prevState, nextProps)=>({
      number: prevState.number + 1
    }))
    this.setState((prevState, nextProps)=>({
      number: prevState.number + 1
    }))
    this.setState((prevState, nextProps)=>({
      number: prevState.number + 1
    }))
  };
  render(){
    return (
      <div>
        <span>{this.state.number}</span>
        <button onClick={this.clickHandle}>click me</button>
      </div>
    )
  }
}
```

çŒœä¸€çŒœç‚¹å‡»äº†`click me`ä¹‹åä¼šnumberæ˜¯å¤šå°‘å‘¢ã€‚
ç­”æ¡ˆæ˜¯4ï¼Œè¿™ä¸å°±æ˜¯æˆ‘ä»¬æ¢¦å¯ä»¥æ±‚çš„ç»“æœå˜›ã€‚æ˜¯ä¸æ˜¯æœ‰ç‚¹æ„æƒ³ä¸åˆ°ï¼Œå‰é¢æˆ‘ä»¬å·²ç»è®¤å®šäº†stateè®°ä¸ä½ï¼Œç°åœ¨è¿™ç”»é£å˜å¾—æœ‰ç‚¹å¿«ã€‚è€Œä¸”è§†å›¾åªä¼šæ›´æ–°ä¸€æ¬¡å“¦ã€‚

è¿™ä¸€è¿ä¸²çš„`setState`æ˜¯å¦‚ä½•åˆå¹¶çš„å‘¢ã€‚

æˆ‘ä»¿ä½›çœ‹åˆ°äº†å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„`å‡½å­(Functor)`å’Œ`ç®¡é“(pipe)`ï¼Œæˆ‘æƒ³Reactåœ¨æŠŠ`setState`æ”¾å…¥`dirtyCompoents`ä¹‹å‰ï¼Œåº”è¯¥ä¹Ÿæ˜¯ç”¨ä¸€ä¸ªå‡½å­å¯¹ä»–è¿›è¡ŒåŒ…è£…ï¼Œåœ¨`updateComponents`æ—¶ï¼Œåº”è¯¥æ˜¯æœ‰ä¸€ä¸ªç±»ä¼¼`co`çš„è‡ªæ‰§è¡Œæ–¹æ³•ï¼Œå¯¹å‡½å­è¿›è¡Œé¡ºåºè°ƒç”¨ğŸ˜„ï¼Œä¸­é—´çš„è¿‡ç¨‹å˜é‡éƒ½æ˜¯ä¸ä¼šä¸¢çš„ã€‚å—¯ï¼Œè¿™å¾ˆå‡½æ•°å¼ã€‚

å¼•ç”¨ç¨‹å¢¨è€å¸ˆçš„ä¸€æ®µè¯
>   è®©setStateæ¥å—ä¸€ä¸ªå‡½æ•°çš„APIè®¾è®¡å¾ˆæ£’ï¼å› ä¸ºè¿™ç¬¦åˆå‡½æ•°å¼ç¼–ç¨‹çš„æ€æƒ³ï¼Œè®©å¼€å‘è€…å†™å‡ºæ²¡æœ‰å‰¯ä½œç”¨çš„å‡½æ•°ï¼Œæˆ‘ä»¬çš„incrementå‡½æ•°å¹¶ä¸å»ä¿®æ”¹ç»„ä»¶çŠ¶æ€ï¼Œåªæ˜¯æŠŠâ€œå¸Œæœ›çš„çŠ¶æ€æ”¹å˜â€è¿”å›ç»™Reactï¼Œç»´æŠ¤çŠ¶æ€è¿™äº›è‹¦åŠ›æ´»å®Œå…¨äº¤ç»™Reactå»åšã€‚
[@ç¨‹å¢¨Morgan](https://www.zhihu.com/people/morgancheng/activities)


[ã€ŠsetStateï¼šè¿™ä¸ªAPIè®¾è®¡åˆ°åº•æ€ä¹ˆæ ·ã€‹](https://zhuanlan.zhihu.com/p/25954470)
